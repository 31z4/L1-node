access_log  /var/log/nginx/node-access.log node buffer=256k;

limit_req   zone=one burst=200 nodelay;

root  /usr/src/app/;

location = / {
    add_header 'Strict-Transport-Security'      'max-age=63072000; includeSubDomains; preload' always;
    return 302 https://strn.network;
}

location ~ ^/(ipns|api)/ {
    proxy_pass  https://ipfs.io;

    if ($request_method = 'OPTIONS') {
        add_header 'Timing-Allow-Origin'            '*';
        add_header 'Access-Control-Allow-Origin'    '*';
        add_header 'Access-Control-Allow-Methods'   'GET, POST, OPTIONS';
        add_header 'Access-Control-Allow-Headers'   'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
        add_header 'Access-Control-Max-Age'         1728000;
        add_header 'Content-Type'                   'text/plain; charset=utf-8';
        add_header 'Content-Length'                 0;
        return 204;
    }
}

location / {
    # TODO: This param is only required for untrusted 3rd party L1 operators.
    # if ($arg_clientId = "") {
    #     return 403;
    # }

    proxy_pass              http://node_backend;
    proxy_buffering         on;
    proxy_http_version      1.1;

    proxy_read_timeout          30m;
    proxy_connect_timeout       121s;
    proxy_ignore_client_abort   on;

    proxy_set_header        Host                $host;
    proxy_set_header        X-Real-IP           $remote_addr;
    proxy_set_header        X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header        X-If-None-Match     $http_if_none_match;
    proxy_set_header        Connection          "";
    proxy_set_header        Saturn-Transfer-Id  $request_id;

    proxy_cache                 my_cache;
    proxy_cache_key             $uri$format_final$arg_filename$arg_download$param_go_get$http_if_none_match;
    proxy_cache_lock            on;
    proxy_cache_valid           200 301 302 410     365d;
    proxy_cache_valid           any                 1m;
    proxy_cache_lock_age        30m;
    proxy_cache_lock_timeout    30m;
    proxy_cache_use_stale       error timeout invalid_header updating http_500 http_502 http_503 http_504 http_429;
    proxy_cache_bypass          $arg_nocache;
    proxy_no_cache              $arg_nocache;

    add_header 'Saturn-Cache-Status'            $upstream_cache_status;
    add_header 'Saturn-Transfer-Id'             $request_id;
    add_header 'Timing-Allow-Origin'            '*';
    add_header 'Access-Control-Allow-Origin'    '*' always;
    add_header 'Access-Control-Allow-Methods'   'GET, POST, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers'   'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;
    add_header 'Access-Control-Expose-Headers'  '*' always;
    add_header 'Strict-Transport-Security'      'max-age=63072000; includeSubDomains; preload' always;
    # Add Alt-Svc header to negotiate HTTP/3.
    add_header Alt-Svc 'h3-27=":443"; ma=86400, h3-28=":443"; ma=86400, h3-29=":443"; ma=86400, h3=":443"; ma=86400';
    # Tell the client QUIC was used
    add_header QUIC-Status $http3;

    client_max_body_size 10g;

    if ($request_method = 'OPTIONS') {
        add_header 'Timing-Allow-Origin'            '*';
        add_header 'Access-Control-Allow-Origin'    '*';
        add_header 'Access-Control-Allow-Methods'   'GET, POST, OPTIONS';
        add_header 'Access-Control-Allow-Headers'   'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
        add_header 'Access-Control-Expose-Headers'  '*' always;
        add_header 'Access-Control-Max-Age'         1728000;
        add_header 'Content-Type'                   'text/plain; charset=utf-8';
        add_header 'Content-Length'                 0;
        return 204;
    }

    if ($format_header = 'carv2') {
        return 400 'unsupported CAR version: only version=1 is supported';
    }
}

location ~* ^.*(QmPgVA4M2EGijWDtH59EYPSPXQhahsVUUytrs1wPJwpgBh|bafybeidgnebuxvarpnw2grmkgnamu6cv6|bafkreibk3n7kxz6ep4g6z6wr737jbd3upibwkzskp6olu7at7qa6bhrrc4|QmTuWjNEmtUd2HGqH5UJzBJ83EFE1yVLxsfgQvUmnFDdan|QmXg6yZZaehZuCzUmBQgfXQqsYF1vb1fJxaypXBPHPEXM7|bafkreibbogdqa6ikxpx56m2rcun3h5ygkrujhhqk6jgj3apwii6cgjpa4i|bafybeicp3x52jgy3qhsrwaioemeck7vhnryq2i2dgodkakkixuzruo54wa|bafybeigyoslufnbi5haonpc3yiktbpdyvas7mqprpvb7wx2jsqyyn65oau|bafybeiaywbhyg43vdl3kkgybpbczcijr2cy4me7tozmc23asq3q4l7znqi|bafybeiaq2wlk4yrt7xpvdzdcurssnxsgamzzvtjdlqkzr7mdhtfopdsmre|bafkreidvok3ip6owxv4npbwt2ok3eljtht7fkjttwwcbfo7nsfqodrarsa|bafybeihllbqrdebl75jrgjyp3o5f4thsyhrzoquqxbisvssfl5hxnxhbey|QmU31Zr3DdDkF2czLfupdYcCkG3rfnef6BsphuCGh4LY4m).*$ {
    return 410;
}

location = /basic_status {
    stub_status;
}
